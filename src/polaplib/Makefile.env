# Makefile.envs
# Version: v0.2.0 (2025-10-18)
# Purpose: one-liners to export, recreate, update, and verify all polap-* Conda envs
# Requires: polap-bash-conda-sync.sh (v0.7.0+) in repo root (does NOT need +x)

# Path to the driver script (absolute path next to this Makefile)
POLAPLIB_DIR := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))
POLAP_CONDA_SYNC ?= $(POLAPLIB_DIR)/polap-bash-conda-sync.sh

# Platform for lock listing (matches what your script writes)
PLATFORM ?= linux-64

# Compute ENVS dynamically:
# 1) If envs/<ENV>/environment.yml exist (after first export), list those
# 2) Otherwise, ask the driver to "verify" and scrape env names it prints
ENVS ?= $(shell \
	if ls -1d $(POLAPLIB_DIR)/envs/polap-* >/dev/null 2>&1; then \
		ls -1d $(POLAPLIB_DIR)/envs/polap-* | xargs -n1 basename; \
	else \
		bash $(POLAP_CONDA_SYNC) verify | awk '/Verify/{print $$3}'; \
	fi \
)

# Optional knobs (pass on command line, e.g., make recreate STRICT_LOCK=--strict-lock)
STRICT_LOCK ?=
REPLACE     ?=
PRUNE       ?=

.PHONY: help export export-full recreate update verify envs locks clean-locks clean-envs list

help:
	@echo "Targets:"
	@echo "  export         - Export YAML (+ lock) for all polap-* envs"
	@echo "  export-full    - Export full YAML (no --from-history)"
	@echo "  recreate       - Recreate all envs from YAML (add STRICT_LOCK=--strict-lock for exact lock)"
	@echo "  update         - Update all envs from YAML (add PRUNE=--prune to remove extras)"
	@echo "  verify         - Check that key tools exist on PATH per env"
	@echo "  locks          - List lock files for $(PLATFORM)"
	@echo "  clean-locks    - Delete lock files for $(PLATFORM)"
	@echo "  clean-envs     - Remove all Conda envs listed in ENVS (DANGEROUS)"
	@echo "  list           - Print the env names this Makefile will operate on"
	@echo ""
	@echo "Examples:"
	@echo "  make export"
	@echo "  make recreate                 # from YAML"
	@echo "  make recreate STRICT_LOCK=--strict-lock  # from lock (exact)"
	@echo "  make update PRUNE=--prune"
	@echo "  make verify"
	@echo "  make recreate ENVS=\"polap-fmlrc2 polap-graphaligner\""

list:
	@printf "%s\n" $(ENVS)

# ----- Bulk targets -----------------------------------------------------------

export:
	bash $(POLAP_CONDA_SYNC) export

export-full:
	bash $(POLAP_CONDA_SYNC) export --full

recreate: $(ENVS:%=recreate-%)

update: $(ENVS:%=update-%)

verify:
	bash $(POLAP_CONDA_SYNC) verify

locks:
	@ls -1 $(POLAPLIB_DIR)/locks/*-$(PLATFORM).txt 2>/dev/null || true

clean-locks:
	@rm -f $(POLAPLIB_DIR)/locks/*-$(PLATFORM).txt

# DANGEROUS: removes conda environments entirely
clean-envs:
	@set -e; \
	for e in $(ENVS); do \
		echo "[clean-envs] Removing $$e ..."; \
		conda remove -n $$e --all -y || true; \
	done

# ----- Per-env pattern rules --------------------------------------------------

recreate-%:
	bash $(POLAP_CONDA_SYNC) recreate --env $* $(STRICT_LOCK) $(REPLACE)

update-%:
	bash $(POLAP_CONDA_SYNC) update --env $* $(PRUNE)
