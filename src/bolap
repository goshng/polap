#!/usr/bin/env bash
set -euo pipefail

if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
	echo "[ERROR] This script must be executed, not sourced: use 'bash $BASH_SOURCE'" >&2
	return 1 2>/dev/null || exit 1
fi

: "${_POLAP_DEBUG:=0}"
export _POLAP_DEBUG
: "${_POLAP_RELEASE:=1}"
export _POLAP_RELEASE

_local_host="thorne"
_media_dir="/media/h2/sra"
_media1_dir="/media/h1/sra"
_media2_dir="/media/h2/sra"

# Local site defaults (override via env if needed)
: "${_LOCAL_HOST:=thorne}"
: "${_MEDIA_DIR:=/media/h2/sra}"

# Determine base
_polap_script_bin_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" || {
	echo "Couldn't determine the script's running directory, bailing out" >&2
	exit 2
}
_POLAPLIB_DIR="${_polap_script_bin_dir}/polaplib"

# ── NEW: trace-load flag
for arg in "$@"; do
	case "$arg" in
	--trace-load)
		export POLAP_AUTOLOAD_TRACE=1
		shift
		;;
	esac
done

# Version early (optional; autoloader will load again if needed)
source "${_POLAPLIB_DIR}/polap-lib-version.sh"

# Parse args for bolap (kept as you had)
source "${_POLAPLIB_DIR}/bolap-parsing.sh"
_polap_output_dest="/dev/null"

# ── NEW: Use the bolap autoloader
source "${_POLAPLIB_DIR}/polap-bash-bolap-autoload-min.sh"
: "${_bolap_type:=read}"
bolap_autoload_min "${_POLAPLIB_DIR}" "${_bolap_type}"

# MAIN
if [ $# -eq 0 ]; then
	print_help
	exit 0
fi

# Dispatch
if declare -f "_run_bolap_${_brg_menu[0]}" >/dev/null 2>&1; then
	_run_bolap_${_brg_menu[0]}
else
	_run_bolap "${_brg_menu[0]}"
fi
