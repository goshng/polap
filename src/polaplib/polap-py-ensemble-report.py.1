#!/usr/bi#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
polap-py-ensemble-report.py  v0.2.0  (combined mt + pt)

Build a single HTML report covering:
  - Coverage (shared)
  - MT (coverage vs PPR vs ensemble)
  - PT (optional; coverage vs PPR vs ensemble)

Inputs:
  --prefix OUT                base prefix (for display only)
  --quickview TSV             e.g., xyz.quickview.tsv
  --xlda-prefix PATH          coverage prefix, e.g., xyz.xcover
  --ppr-prefix PATH           MT ppr prefix, e.g., xyz.ppr.mt
  --ensemble-prefix PATH      MT ensemble prefix, e.g., xyz.ensemble.mt

Optional PT:
  --ppr-pt-prefix PATH        PT ppr prefix, e.g., xyz.ppr.pt
  --ensemble-pt-prefix PATH   PT ensemble prefix, e.g., xyz.ensemble.pt

Outputs:
  -o report.html
"""

import argparse, os, base64, html

VERSION = "0.2.0"


def load_ids(path):
    S = set()
    if path and os.path.exists(path):
        with open(path) as fh:
            for line in fh:
                t = line.strip().split()
                if t:
                    S.add(t[0])
    return S


def read_text_head(path, n=200):
    if not path or not os.path.exists(path):
        return ""
    try:
        with open(path) as f:
            return (
                "<pre class='small'>"
                + html.escape("".join(f.readlines()[:n]))
                + "</pre>"
            )
    except Exception as e:
        return f"<pre class='small'>(error reading {html.escape(path)}: {html.escape(str(e))})</pre>"


def embed_png(path):
    if not path or not os.path.exists(path):
        return ""
    try:
        with open(path, "rb") as f:
            b64 = base64.b64encode(f.read()).decode("ascii")
        return f'<img alt="{html.escape(os.path.basename(path))}" src="data:image/png;base64,{b64}" style="max-width:100%;height:auto;border:1px solid #ccc;padding:4px;">'
    except Exception as e:
        return f"<div class='small'>(error embedding {html.escape(path)}: {html.escape(str(e))})</div>"


def head(title):
    return f"""<!doctype html><html><head><meta charset="utf-8">
<title>{html.escape(title)}</title>
<style>
body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;}}
h1,h2{{margin-top:1.1em}}
table{{border-collapse:collapse;margin:10px 0}}
td,th{{border:1px solid #ddd;padding:6px 10px;font-size:90%}}
code{{background:#f7f7f7;padding:2px 4px;border:1px solid #eee}}
.small{{font-size:85%;color:#555}}
.block{{display:block;margin:8px 0}}
hr{{border:0;border-top:1px solid #eee;margin:20px 0}}
.section-title{{margin-top:24px}}
</style></head><body>
"""


def tail():
    return "</body></html>"


def count_if(path):
    return len(load_ids(path)) if path and os.path.exists(path) else 0


def mt_block(prefix_cov, prefix_ppr, prefix_ens, label="MT"):
    """Return HTML for an organelle block (mt or pt)."""
    ids_cov = f"{prefix_cov}.{label.lower()}.ids"
    ids_ppr = f"{prefix_ppr}.ids"
    ids_ppr_nuc = f"{prefix_ppr}.nuclear.ids"
    ppr_scores = f"{prefix_ppr}.scores.tsv"
    ppr_gstats = f"{prefix_ppr}.graph.stats.txt"

    ids_ens = f"{prefix_ens}.ids"
    ids_ens_nuc = f"{prefix_ens}.nuclear.ids"
    ens_report = f"{prefix_ens}.report.tsv"

    rows = []
    rows.append(f"<h2 class='section-title'>{html.escape(label)} summary</h2>")
    rows.append("<table><tr><th>Set</th><th>Count</th><th>Path</th></tr>")
    rows.append(
        f"<tr><td>Coverage {label.lower()}</td><td>{count_if(ids_cov)}</td><td><code>{html.escape(ids_cov) if os.path.exists(ids_cov) else '(missing)'}</code></td></tr>"
    )
    rows.append(
        f"<tr><td>PPR {label.lower()}</td><td>{count_if(ids_ppr)}</td><td><code>{html.escape(ids_ppr) if os.path.exists(ids_ppr) else '(missing)'}</code></td></tr>"
    )
    rows.append(
        f"<tr><td>Ensemble {label.lower()}</td><td>{count_if(ids_ens)}</td><td><code>{html.escape(ids_ens) if os.path.exists(ids_ens) else '(missing)'}</code></td></tr>"
    )
    rows.append("</table>")

    # PPR details
    gtxt = read_text_head(ppr_gstats, n=200)
    stxt = read_text_head(ppr_scores, n=50)
    if gtxt or stxt:
        rows.append("<h3>PPR details</h3>")
        if gtxt:
            rows.append(gtxt)
        if stxt:
            rows.append("<p class='small'><b>Top scores (head)</b></p>" + stxt)

    # Ensemble report
    etxt = read_text_head(ens_report, n=200)
    if etxt:
        rows.append("<h3>Ensemble overlap</h3>")
        rows.append(etxt)

    return "\n".join(rows)


def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--prefix", required=True)
    ap.add_argument("--quickview", required=True)
    ap.add_argument("--xlda-prefix", required=True, dest="cov_prefix")  # coverage
    ap.add_argument("--ppr-prefix", required=True, dest="ppr_mt_prefix")
    ap.add_argument("--ensemble-prefix", required=True, dest="ens_mt_prefix")
    # optional pt prefixes
    ap.add_argument("--ppr-pt-prefix", dest="ppr_pt_prefix")
    ap.add_argument("--ensemble-pt-prefix", dest="ens_pt_prefix")
    ap.add_argument("--title", default="POLAP organelle selection report (mt + pt)")
    ap.add_argument("-o", "--out", required=True, dest="out_html")
    args = ap.parse_args()

    # Coverage pieces
    img_x = embed_png(f"{args.cov_prefix}.x_hist.png")
    # kmer PCA not used in this pipeline; ok if missing
    # img_k = embed_png(f"{args.cov_prefix}.kmer_pca.png")

    parts = []
    parts.append(head(args.title))
    parts.append(f"<h1>{html.escape(args.title)}</h1>")

    # Coverage / inputs
    parts.append("<h2>Coverage & inputs</h2>")
    parts.append("<ul>")
    parts.append(
        f"<li>Quickview TSV: <code>{html.escape(args.quickview)}</code> {'(missing)' if not os.path.exists(args.quickview) else ''}</li>"
    )
    parts.append(
        f"<li>Coverage prefix: <code>{html.escape(args.cov_prefix)}</code></li>"
    )
    parts.append(
        f"<li>MT PPR prefix: <code>{html.escape(args.ppr_mt_prefix)}</code></li>"
    )
    parts.append(
        f"<li>MT ensemble prefix: <code>{html.escape(args.ens_mt_prefix)}</code></li>"
    )
    if args.ppr_pt_prefix or args.ens_pt_prefix:
        parts.append(
            f"<li>PT PPR prefix: <code>{html.escape(args.ppr_pt_prefix or '(none)')}</code></li>"
        )
        parts.append(
            f"<li>PT ensemble prefix: <code>{html.escape(args.ens_pt_prefix or '(none)')}</code></li>"
        )
    parts.append("</ul>")
    if img_x:
        parts.append("<h3>Coverage X histogram & bands</h3>")
        parts.append(img_x)

    # MT block
    parts.append(
        mt_block(args.cov_prefix, args.ppr_mt_prefix, args.ens_mt_prefix, label="MT")
    )

    # PT block (optional)
    if args.ppr_pt_prefix and args.ens_pt_prefix:
        # only render if at least one of the key files exists
        if (
            os.path.exists(f"{args.cov_prefix}.pt.ids")
            or os.path.exists(f"{args.ppr_pt_prefix}.ids")
            or os.path.exists(f"{args.ens_pt_prefix}.ids")
        ):
            parts.append("<hr/>")
            parts.append(
                mt_block(
                    args.cov_prefix, args.ppr_pt_prefix, args.ens_pt_prefix, label="PT"
                )
            )

    parts.append(tail())

    os.makedirs(os.path.dirname(args.out_html) or ".", exist_ok=True)
    with open(args.out_html, "w") as w:
        w.write("".join(parts))
    print(f"[report] {args.out_html}")


if __name__ == "__main__":
    main()
