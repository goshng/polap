# Makefile.envs
# Version: v0.4.0 (2025-10-18)
# Purpose: one-liners to export, recreate, update, and verify all polap-* Conda envs
# Requires: polap-bash-conda-sync.sh (v0.8.0+) in the same directory (POLAPLIB_DIR)

# ------------------------------------------------------------------------------

# Path to this makefile's directory (your polaplib dir)
POLAPLIB_DIR := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))

# Driver script
POLAP_CONDA_SYNC ?= $(POLAPLIB_DIR)/polap-bash-conda-sync.sh

# Base directory for envs/ and locks/
export POLAP_CONDA_SYNC_ROOT := $(POLAPLIB_DIR)

# Platform for lock listing
PLATFORM ?= linux-64

# Compute ENVS dynamically
ENVS ?= $(shell \
	if ls -1d $(POLAPLIB_DIR)/envs/polap* >/dev/null 2>&1; then \
		ls -1d $(POLAPLIB_DIR)/envs/polap* | xargs -n1 basename; \
	else \
		bash $(POLAP_CONDA_SYNC) verify | awk '/Verify/{print $$3}'; \
	fi \
)

# ---- Skip some environments permanently ----
# Always skip polap-dev (can add more, separated by spaces)
SKIP_ALWAYS := polap-dev
ENVS := $(filter-out $(SKIP_ALWAYS),$(ENVS))

# Optional runtime knobs
STRICT_LOCK ?=
REPLACE     ?=
PRUNE       ?=

.PHONY: help export export-full recreate recreate-skip update verify envs locks clean-locks clean-envs list

help:
	@echo "Targets:"
	@echo "  export          - Export YAML (+ lock) for all polap-* envs"
	@echo "  export-full     - Export full YAML (no --from-history)"
	@echo "  recreate        - Recreate all envs from YAML"
	@echo "  recreate-skip   - Recreate only missing envs (--skip-existing)"
	@echo "  update          - Update all envs from YAML"
	@echo "  verify          - Check that key tools exist on PATH per env"
	@echo "  locks           - List lock files for $(PLATFORM)"
	@echo "  clean-locks     - Delete lock files for $(PLATFORM)"
	@echo "  clean-envs      - Remove all Conda envs listed in ENVS (DANGEROUS)"
	@echo "  list            - Print the env names this Makefile will operate on"
	@echo ""
	@echo "Examples:"
	@echo "  make recreate"
	@echo "  make recreate-skip                 # skip existing envs"
	@echo "  make recreate STRICT_LOCK=--strict-lock REPLACE=--replace"
	@echo "  make update PRUNE=--prune"
	@echo "  make verify"
	@echo "  make recreate ENVS=\"polap-fmlrc2 polap-graphaligner\""

list:
	@printf "%s\n" $(ENVS)

# ----- Bulk targets -----------------------------------------------------------

export:
	bash $(POLAP_CONDA_SYNC) export

export-full:
	bash $(POLAP_CONDA_SYNC) export --full

# recreate all (normal)
recreate: $(ENVS:%=recreate-%)

# recreate all, skipping existing ones
recreate-skip: $(ENVS:%=recreate-skip-%)

update: $(ENVS:%=update-%)

verify:
	bash $(POLAP_CONDA_SYNC) verify

locks:
	@ls -1 $(POLAPLIB_DIR)/locks/*-$(PLATFORM).txt 2>/dev/null || true

clean-locks:
	@rm -f $(POLAPLIB_DIR)/locks/*-$(PLATFORM).txt

clean-envs:
	@set -e; \
	for e in $(ENVS); do \
		echo "[clean-envs] Removing $$e ..."; \
		conda remove -n $$e --all -y || true; \
	done

# ----- Per-env pattern rules --------------------------------------------------

recreate-%:
	bash $(POLAP_CONDA_SYNC) recreate --env $* $(STRICT_LOCK) $(REPLACE)

# same as recreate-%, but add --skip-existing
recreate-skip-%:
	bash $(POLAP_CONDA_SYNC) recreate --env $* --skip-existing $(STRICT_LOCK) $(REPLACE)

update-%:
	bash $(POLAP_CONDA_SYNC) update --env $* $(PRUNE)

